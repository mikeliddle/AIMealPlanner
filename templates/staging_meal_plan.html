{% extends "base.html" %} {% block title %}Stage Meal Plan - AI Meal Planner{%
endblock %} {% block content %}
<div class="card">
  <h2>üéØ Review & Customize Your Meal Plan</h2>
  <p>Week of {{ plan.start_date }}</p>
  <p class="alert alert-info">
    üìù Review your meal plan below. You can swap any recipe before accepting the
    plan.
  </p>
</div>

<div class="card">
  <h2>üìÖ Weekly Schedule</h2>
  <table>
    <thead>
      <tr>
        <th>Day</th>
        <th>Date</th>
        <th>Meal</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="mealSchedule">
      {% for item in recipes_with_days %}
      <tr data-day-index="{{ item.day_index }}">
        <td><strong>{{ item.day }}</strong></td>
        <td>{{ item.date }}</td>
        <td class="recipe-name">{{ item.recipe.name }}</td>
        <td>
          <a
            href="{{ url_for('view_recipe', recipe_id=item.recipe.id) }}"
            class="btn btn-secondary"
            target="_blank"
            >View Recipe</a
          >
          <button
            class="btn btn-warning swap-btn"
            data-day-index="{{ item.day_index }}"
            data-current-recipe="{{ item.recipe.id }}"
          >
            Swap Recipe
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h2>üõí Grocery List</h2>
  <p>This list will update automatically when you swap recipes.</p>

  <table id="groceryList">
    <thead>
      <tr>
        <th>Item</th>
        <th>Total Quantity</th>
        <th>Unit</th>
      </tr>
    </thead>
    <tbody>
      {% for item in plan.grocery_list %}
      <tr>
        <td><strong>{{ item.item|title }}</strong></td>
        <td>{{ item.quantity }}</td>
        <td>{{ item.unit }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h2>‚úÖ Accept Plan</h2>

  {% if calendar_configured %}
  <div class="form-group">
    <input type="checkbox" id="addToCalendar" />
    <label for="addToCalendar">Add meals to Google Calendar now</label>
    <p style="font-size: 0.9em; color: #666; margin-left: 25px">
      Each meal will be added as an event at 5:00 PM with a 1-hour reminder. You
      can also add to calendar later from the meal plan page.
    </p>
  </div>
  {% else %}
  <div class="alert alert-info">
    <p>üìÖ <strong>Google Calendar not configured.</strong></p>
    <p>
      To add meals to your calendar, set up your Google Calendar credentials.
      See the documentation for instructions.
    </p>
  </div>
  {% endif %}

  <button id="acceptBtn" class="btn btn-success">Accept Meal Plan</button>
  <button id="deleteBtn" class="btn btn-danger">Delete Plan</button>
  <a href="{{ url_for('meal_plans') }}" class="btn btn-secondary"
    >Back to Plans</a
  >
</div>

<!-- Modal for recipe swap -->
<div
  id="swapModal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
  "
>
  <div
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    "
  >
    <h3>Choose a Different Recipe</h3>
    <p>Select a recipe to use instead:</p>

    <div class="form-group" style="margin: 15px 0;">
      <input 
        type="text" 
        id="recipeSearch" 
        placeholder="üîç Search recipes by name, category, or ingredient..."
        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
      />
    </div>

    <div id="recipeList" style="margin: 20px 0">
      {% for recipe in all_recipes %}
      <div
        class="recipe-option"
        style="
          padding: 10px;
          margin: 5px 0;
          border: 1px solid #ddd;
          border-radius: 4px;
          cursor: pointer;
        "
        data-recipe-id="{{ recipe.id }}"
        data-recipe-name="{{ recipe.name }}"
        data-recipe-category="{{ recipe.category or '' }}"
        data-recipe-description="{{ recipe.description }}"
        data-recipe-ingredients="{{ recipe.ingredients | map(attribute='item') | join(', ') }}"
      >
        <strong>{{ recipe.name }}</strong>
        {% if recipe.category %}
        <span style="font-size: 0.85em; color: #007bff; margin-left: 10px;">{{ recipe.category }}</span>
        {% endif %}
        <p style="font-size: 0.9em; color: #666; margin: 5px 0">
          {{ recipe.description }}
        </p>
      </div>
      {% endfor %}
    </div>

    <button id="closeModal" class="btn btn-secondary">Cancel</button>
  </div>
</div>

<div
  id="loadingOverlay"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
  "
>
  <div
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
    "
  >
    <div class="alert alert-info">
      <p>Processing... Please wait.</p>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  const planId = {{ plan.id }};
  let currentDayIndex = null;

  // Swap recipe functionality
  document.querySelectorAll('.swap-btn').forEach(btn => {
      btn.addEventListener('click', function() {
          currentDayIndex = parseInt(this.dataset.dayIndex);
          document.getElementById('swapModal').style.display = 'block';
      });
  });

  // Close modal
  document.getElementById('closeModal').addEventListener('click', function() {
      document.getElementById('swapModal').style.display = 'none';
      currentDayIndex = null;
      document.getElementById('recipeSearch').value = '';
      filterRecipes();
  });

  // Recipe search functionality
  document.getElementById('recipeSearch').addEventListener('input', function() {
      filterRecipes();
  });

  function filterRecipes() {
      const searchTerm = document.getElementById('recipeSearch').value.toLowerCase();
      const recipeOptions = document.querySelectorAll('.recipe-option');
      
      recipeOptions.forEach(option => {
          const name = option.dataset.recipeName.toLowerCase();
          const category = option.dataset.recipeCategory.toLowerCase();
          const description = option.dataset.recipeDescription.toLowerCase();
          const ingredients = option.dataset.recipeIngredients.toLowerCase();
          
          const matches = name.includes(searchTerm) || 
                         category.includes(searchTerm) || 
                         description.includes(searchTerm) ||
                         ingredients.includes(searchTerm);
          
          option.style.display = matches ? 'block' : 'none';
      });
  }

  // Select recipe from modal
  document.querySelectorAll('.recipe-option').forEach(option => {
      option.addEventListener('click', function() {
          const newRecipeId = parseInt(this.dataset.recipeId);
          swapRecipe(currentDayIndex, newRecipeId);
      });
  });

  async function swapRecipe(dayIndex, newRecipeId) {
      document.getElementById('loadingOverlay').style.display = 'block';

      try {
          const response = await fetch(`/meal-plans/${planId}/swap`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  day_index: dayIndex,
                  new_recipe_id: newRecipeId
              })
          });

          const result = await response.json();

          if (result.success) {
              // Reload the page to show updated meal plan and grocery list
              window.location.reload();
          } else {
              alert('Error swapping recipe: ' + result.error);
              document.getElementById('loadingOverlay').style.display = 'none';
          }
      } catch (error) {
          alert('Error: ' + error);
          document.getElementById('loadingOverlay').style.display = 'none';
      }

      document.getElementById('swapModal').style.display = 'none';
  }

  // Accept plan
  document.getElementById('acceptBtn').addEventListener('click', async function() {
      const addToCalendar = document.getElementById('addToCalendar')?.checked || false;

      if (!confirm('Accept this meal plan? It will be moved to your accepted plans.')) {
          return;
      }

      document.getElementById('loadingOverlay').style.display = 'block';

      try {
          const response = await fetch(`/meal-plans/${planId}/accept`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  add_to_calendar: addToCalendar
              })
          });

          const result = await response.json();

          if (result.success) {
              if (result.calendar_result) {
                  if (result.calendar_result.success) {
                      alert('‚úÖ ' + result.calendar_result.message);
                  } else {
                      alert('‚ö†Ô∏è Plan accepted but calendar sync failed: ' + result.calendar_result.error);
                  }
              }
              window.location.href = result.redirect;
          } else if (result.needs_authorization) {
              // Redirect to Google authorization
              alert(result.message);
              window.location.href = result.authorization_url;
          } else {
              alert('Error accepting plan: ' + result.error);
              document.getElementById('loadingOverlay').style.display = 'none';
          }
      } catch (error) {
          alert('Error: ' + error);
          document.getElementById('loadingOverlay').style.display = 'none';
      }
  });

  // Delete plan
  document.getElementById('deleteBtn').addEventListener('click', async function() {
      if (!confirm('Delete this meal plan? This cannot be undone.')) {
          return;
      }

      document.getElementById('loadingOverlay').style.display = 'block';

      try {
          const response = await fetch(`/meal-plans/${planId}/delete`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              }
          });

          const result = await response.json();

          if (result.success) {
              window.location.href = result.redirect;
          } else {
              alert('Error deleting plan: ' + result.error);
              document.getElementById('loadingOverlay').style.display = 'none';
          }
      } catch (error) {
          alert('Error: ' + error);
          document.getElementById('loadingOverlay').style.display = 'none';
      }
  });
</script>
{% endblock %}
